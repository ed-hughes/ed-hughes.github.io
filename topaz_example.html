<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://widgets.jotform.io/lib/base.css" />
    <style>

                  #sigplus { border: 1px solid #666; }
            #validationInfo,#stage,#noTablet,#loader { display: none; }
    </style>
    <script src="https://cdn.jotfor.ms/s/umd/latest/for-custom-widgets.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="https://www.sigplusweb.com/SigWebTablet.js"></script>
  </head>
  <body>
    <div id="wrapper">
      <div id="stage">
        <canvas id="sigWeb"></canvas>
        <button id="startSign">Start</button>
        <button id="clearSign">Clear</button>
        <button id="finishSign">Finish</button>
        <span id="validationInfo" class="negative"
          >‚Üê You have to finish sign before submitting form!</span
        >
        <!-- <img id="loader" src="loader.gif" alt="" /> -->
      </div>
      <div id="noTablet">Signature Tablet is not installed.</div>
    </div>

    <script>

      
      JFCustomWidgetUtils.domReady(function () {

        
var SigPlusWidget = function(canvasId, image) {
    var bodyWidth = 0;
    var bodyHeight = 0;

    var timer;

    var signInProgress = false;
    var widgetValue = '';
    var tmr;
    this.getData = getData;
  
    function getData() {
        if(signInProgress) {
            jQuery('#validationInfo').show();
            return {
                'value' : '',
                'valid' : false,
            }
        }

        return {
            'value' : widgetValue,
            'valid' : widgetValue !== '',
        };
    };

    var init = function() {
        if(image) {
            buildStaticPad(image);
            return;
        }

        try {
            GetTabletState();
        } catch(e) {
            console.log(e);
            jQuery('#stage').hide();
            jQuery('#noTablet').show();
            resizeFrame();
            return;
        }

        jQuery('#startSign').on('click', startSign);
        jQuery('#clearSign').hide().on('click', clearSign);
        jQuery('#finishSign').hide().on('click', finishSign);
        jQuery('#stage').show();
    };

    var buildStaticPad = function(imageSrc) {
        jQuery('#stage').html('<img src="' + imageSrc + '" />');  //.html('<img src="//jotform.com/' + imageSrc + '" alt="" />');
    };

    /**
     * Resize widget frame
     */
    function resizeFrame() {  
      JFCustomWidget.requestFrameResize({
        'width': jQuery('#wrapper').outerWidth() + 10,
        'height': jQuery('#wrapper').height() + 20
      });
    }

    window.onunload = window.onbeforeunload = (function(){
        closingSigWeb();
    });

    function closingSigWeb()
    {
        ClearTablet();
        SetTabletState(0, tmr);
    }

    var clearSign = function() {
        ClearTablet();
    };

    var startSign = function() {

        var ctx = document.getElementById(canvasId).getContext('2d');         
        SetDisplayXSize( 500 );
        SetDisplayYSize( 100 );
        SetTabletState(0, tmr);
        SetJustifyMode(0);
        ClearTablet();
        if(tmr == null)
        {
            tmr = SetTabletState(1, ctx, 50);
        }
        else
        {
            SetTabletState(0, tmr);
            tmr = null;
            tmr = SetTabletState(1, ctx, 50);
        }

        signInProgress = true;
        jQuery('#startSign').hide();
        jQuery('#clearSign, #finishSign').show();
    };

    var SigImageCallback = function( str )
    {
       //document.FORM1.sigImageData.value = str;
       console.log('callback: ' + str);
       widgetValue = '<img src="data:image/jpeg;base64,' + 'iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAAB0ElEQVR4nOzaz2vScRzHcb9lJ8u6JEah0a9bRJcKgxIKqdCQ7OShCBKJoCBSokMgXcpDeOgHUpcwhA4aKQkhBmLzMjaYDjfZwS8OHDIG22CX/WL/wPP+5gPv5/HxAeHF56Jfv84bmzcdVCZwFv3Lue/o0a3j6B+23ehHRj50d3cJPXd3Dn0fqkHpAOl0gHQ6QDrrdbKKB610BT1bGqNvTEXR10cX0CejJf7802X0enke3fgb0AHS6QDpdIB0zuYdFx4ULk2g5xph9MrjQ+jv20P0Yv8fen7hK3q8eRHd+BvQAdLpAOl0gHTWbOgvHvQettE91zrot5oP0AvnY+hHQwfQW51V9Le+LrrxN6ADpNMB0ukA6azxjx4eBOon0fM/I+ivYsvoH/sv0O+95O/36WM19GHmCrrxN6ADpNMB0ukA6awnjQQe3Hfw8/uy14Mec19Gz8b5f4Nfv4vokWk/+tOdPLrxN6ADpNMB0ukA6azqn0d48Om/F33xKr//Y19fQX8+eIe+dph/J5x58wz9lB1EN/4GdIB0OkA6HSCdZfv5OX0wvIueSA3Q7YMn0GufC+i39/N7R65v/J5SKjmDbvwN6ADpdIB0OkC6vQAAAP//xGpiZnzEG2QAAAAASUVORK5CYII=
' + '"/>';
            console.log("sendingData", {str});
    JFCustomWidget.sendData({
              valid: true,
              value: widgetValue
            });
      console.log("sentData", {widgetValue, str})
    }

    var finishSign = function() {

        if(NumberOfTabletPoints() == 0)
        {
            alert("Please sign before continuing");
        }
        else
        {
            SetTabletState(0, tmr);
            //RETURN TOPAZ-FORMAT SIGSTRING
            SetSigCompressionMode(1);
            console.log('SigString: ' + GetSigString());
            //this returns the signature in Topaz's own format, with biometric information

            //RETURN BMP BYTE ARRAY CONVERTED TO BASE64 STRING
            SetImageXSize(500);
            SetImageYSize(100);
            SetImagePenWidth(5);
            GetSigImageB64(SigImageCallback);
        }
        signInProgress = false;

        jQuery('#clearSign, #finishSign, #validationInfo').hide();
        //jQuery('#loader').show();
    }

    init();
};

        JFCustomWidget.subscribe("ready", function () {
          const widget = new SigPlusWidget('sigWeb', '');
          JFCustomWidget.subscribe("submit", function () {
            JFCustomWidget.sendSubmit(widget.getData());
          });
        });
      });
    </script>
  </body>
</html>
