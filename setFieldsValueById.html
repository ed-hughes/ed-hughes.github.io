<!doctype html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KvK Widget</title>
    <script src="https://cdn.jotfor.ms/s/umd/latest/for-custom-widgets.js"></script>
  </head>
  <body>
    <div class="kvk-widget-container">
      <button id="kvk-lookup-button" class="kvk-button" type="button">
        KvK gegevens ophalen
      </button>
    </div>

    <div id="search-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Bedrijf zoeken</h2>
          <span class="close" id="close-modal">&times;</span>
        </div>
        <div class="search-form">
          <input
            type="text"
            id="search-input"
            class="search-input"
            placeholder="Voer bedrijfsnaam in..."
            autocomplete="off"
          />
          <button type="button" id="search-button" class="search-button">
            Zoeken
          </button>
        </div>
        <div id="search-results" class="results-container"></div>
      </div>
    </div>

    <script>
      function DBCC() {
        this.init = init;
        this.getData = getData;

        function init(formData) {
          console.log("DBCC", { formData });
          selectCompany();
        }

        function fillJotformFields(data) {
          console.log("fillJotformFields", JSON.stringify(data));
          const fieldData = [{ id: "4", value: data.companyName || "" }];
          console.log(JSON.stringify(fieldData));
          JFCustomWidget.setFieldsValueById(fieldData);
        }

        async function selectCompany() {
          try {
            let url =
              "https://klikopmorgen-backend.klikopmorgen-backend.workers.dev/kvk-lookup/details?kvkNumber=74372297&vestigingsnummer=000037956744";

            const response = await fetch(url);
            const data = await response.json();

            if (!data.success) {
              const errorMessage = data.message || "Fout bij ophalen gegevens";
              return;
            }

            fillJotformFields(data);
          } catch (error) {
            console.error("Details error:", error);
          }
        }

        function getData() {
          return {
            valid: true,
            value: "TEST",
          };
        }
      }
      JFCustomWidget.subscribe("ready", function (data) {
        var widget = new DBCC();
        widget.init(data);

        JFCustomWidget.subscribe("submit", function () {
          JFCustomWidget.sendSubmit(widget.getData());
        });
      });
    </script>
  </body>
</html>
