<!doctype html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jotfor.ms/s/umd/latest/for-custom-widgets.js"></script>
<style>
  .search-form input {
    padding: 0.6rem 0.75rem;
    font-size: 14px;
    border: 1px solid #d0d5dd;
    border-radius: 6px;
    width: 100%;
  }

  .search-form input:focus {
    outline: none;
    border-color: #4f46e5;
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.15);
  }

  .results-container {
    position: relative;
  }

  .address-list {
    list-style: none;
    padding: 0;
    margin: 0;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #fff;
    max-height: 280px;
    overflow-y: auto;
    box-shadow: 0 8px 24px rgba(0,0,0,0.08);
  }

  .address-item {
    padding: 0.6rem 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid #f1f5f9;
  }

  .address-item:last-child {
    border-bottom: none;
  }

  .address-item:hover {
    background-color: #f8fafc;
  }

  .address-name {
    font-weight: 500;
    color: #111827;
  }

  .address-details {
    font-size: 13px;
    color: #6b7280;
  }

  .highlight {
    font-weight: 600;
    color: #4f46e5;
    background: rgba(79, 70, 229, 0.12);
    border-radius: 3px;
    padding: 0 1px;
  }
</style>

  </head>
  <body>
      <div id="addressArea" style="display:flex; flex-direction: column; gap:1rem;">
      <div class="search-form">
        <input type="text" id="address_line_1" placeholder="Start typing your address here..." />
        <input type="text" id="address_line_2" placeholder="Address line 2" readonly />
        <input type="text" id="city" placeholder="City" readonly/>
        <input type="text" id="state" placeholder="State" readonly/>
        <input type="text" id="postcode" placeholder="Postcode" readonly/>
      </div>
      <div id="search-results" class="results-container"></div>
    </div>

    <script>
      const searchInput = document.getElementById("address_line_1");
      const searchResults = document.getElementById("search-results");
      console.log({
        searchInput: !!searchInput,
        searchResults: !!searchResults,
      });

      function LocateAddressSearch() {

        const widgetSettings = JFCustomWidget.getWidgetSettings();
        const searchLimit = widgetSettings.searchLimit || 10;
        const allowedCountries = widgetSettings.allowedCountries || "GB";
        const serviceKey = widgetSettings.serviceKey;
        
        const API_LIST_URL = "https://api.addressy.com/Capture/Interactive/Find/v1.20/json6.ws";
        const API_RETRIEVE_URL =
          "https://api.addressy.com/Capture/Interactive/Retrieve/v1.30/json6.ws";

        this.init = init;
        this.getData = getData;

        function init(formData) {
          console.log("init", { formData });
          searchInput.addEventListener("input", function (event) {
              console.log("searchInputEvent", event)
              retrieveListOfAddresses(event.target.value);
          });
        }

        function escapeHtml(text) {
          const div = document.createElement("div");
          div.textContent = text || "";
          return div.innerHTML;
        }
        async function retrieveListOfAddresses(searchTerm) {
          console.log("retrieveListOfAddresses", {searchTerm});
          if (!searchTerm) {
            return;
          }
          try {
            const searchParams = new URLSearchParams();
            searchParams.append("Key", serviceKey);
            searchParams.append("Text", searchTerm);
            searchParams.append("Countries", allowedCountries);
            searchParams.append("Limit", searchLimit);
            
            const response = await fetch(
              `${API_LIST_URL}?${searchParams}`
            );
            const data = await response.json();
            displayAddresses(data.Items);
          } catch (error) {
            console.error("Search error:", error);
          }
        }

function displayAddresses(addresses) {
  if (!addresses || !addresses.length) {
    searchResults.innerHTML = "";
    return;
  }

  const list = document.createElement("ul");
  list.className = "address-list";

  addresses.forEach((address) => {
    const item = document.createElement("li");
    item.className = "address-item";
    item.id = address.Id;

    const highlights = parseHighlight(address.Highlight);

    const textHtml = applyHighlight(address.Text || "", highlights.text);
    const descHtml = applyHighlight(
      address.Description || "",
      highlights.description
    );

    item.innerHTML = `
      <div class="address-name">${textHtml}</div>
      <div class="address-details">${descHtml}</div>
    `;

    item.addEventListener("click", () =>
      selectAddress(address.Id)
    );

    list.appendChild(item);
  });

  searchResults.innerHTML = "";
  searchResults.appendChild(list);
}


        async function selectAddress(addressId) {
          try {
            const searchParams = new URLSearchParams();
            searchParams.append("Key", serviceKey);
            searchParams.append("Id", addressId);
            
            const response = await fetch(
              `${API_RETRIEVE_URL}?${searchParams}`
            );
            const data = await response.json();

            console.log("selectAddress", JSON.stringify({ data }));

            if (data.Error) {
              const errorMessage = data.Error || "Invalid lookup";
              JFCustomWidget.showWidgetError(errorMessage);
              return;
            }

            setData(data.Items[0]);
          } catch (error) {
            console.error("Details error:", error);
          }
        }

        function setData(addressData){

      //       {
      // "Id": "GB|RM|B|55605138|ENG",
      // "DomesticId": "55605138",
      // "Language": "ENG",
      // "LanguageAlternatives": "ENG",
      // "Department": "",
      // "Company": "G B G",
      // "SubBuilding": "",
      // "BuildingNumber": "128",
      // "BuildingName": "Evermore",
      // "SecondaryStreet": "",
      // "Street": "Queen Victoria Street",
      // "Block": "",
      // "Neighbourhood": "",
      // "District": "",
      // "City": "London",
      // "Line1": "Evermore",
      // "Line2": "128 Queen Victoria Street",
      // "Line3": "",
      // "Line4": "",
      // "Line5": "",
      // "AdminAreaName": "City of London",
      // "AdminAreaCode": "",
      // "Province": "",
      // "ProvinceName": "",
      // "ProvinceCode": "",
      // "PostalCode": "EC4V 4BJ",
      // "CountryName": "United Kingdom",
      // "CountryIso2": "GB",
      // "CountryIso3": "GBR",
      // "CountryIsoNumber": "826",
      // "SortingNumber1": "74131",
      // "SortingNumber2": "",
      // "Barcode": "(EC4V4BJ2ZE)",
      // "POBoxNumber": "",
      // "Label": "G B G\nEvermore\n128 Queen Victoria Street\nLONDON\nEC4V 4BJ\nUNITED KINGDOM",
      // "Type": "Commercial",
      // "DataLevel": "Premise",
      //   }
            document.getElementById('address_line_1').value = addressData.Line1;
            document.getElementById('address_line_2').value  = addressData.Line2;
            document.getElementById('city').value  = addressData.City;
            document.getElementById('state').value = addressData.ProvinceName;
            document.getElementById('postcode').value = addressData.PostalCode;
        }

        function applyHighlight(text, ranges) {
  if (!ranges || !ranges.length) {
    return escapeHtml(text);
  }

  let result = "";
  let lastIndex = 0;

  ranges.forEach(([start, end]) => {
    result += escapeHtml(text.slice(lastIndex, start));
    result += `<span class="highlight">${escapeHtml(
      text.slice(start, end)
    )}</span>`;
    lastIndex = end;
  });

  result += escapeHtml(text.slice(lastIndex));
  return result;
}

function parseHighlight(highlightString) {
  // Returns { text: [[start,end]], description: [[start,end]] }
  if (!highlightString) {
    return { text: [], description: [] };
  }

  const [textPart = "", descPart = ""] = highlightString.split(";");

  const parseRanges = (part) =>
    part
      .split(",")
      .map(r => r.trim())
      .filter(Boolean)
      .map(r => r.split("-").map(Number));

  return {
    text: parseRanges(textPart),
    description: parseRanges(descPart)
  };
}

  
         function getData() {
            const address_line_1 = document.getElementById('address_line_1').value;
            const address_line_2 = document.getElementById('address_line_2').value;
            const city = document.getElementById('city').value;
            const state = document.getElementById('state').value;
            const postcode = document.getElementById('postcode').value;

          return {
            valid: true,
            value: JSON.stringify({
                address_line_1,
                address_line_2,
                city,
                state,
                postcode
            })
          };
        }
      }
      JFCustomWidget.subscribe("ready", function (data) {
        var widget = new LocateAddressSearch();
        widget.init(data);

        JFCustomWidget.subscribe("submit", function () {
          JFCustomWidget.sendSubmit(widget.getData());
        });
      });
    </script>
  </body>
</html>
