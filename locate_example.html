<!doctype html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jotfor.ms/s/umd/latest/for-custom-widgets.js"></script>
    <style>
    </style>
  </head>
  <body>
      <div id="addressArea" style="display:flex; flex-direction: column; gap:1rem;">
      <div class="search-form">
        <input type="text" id="address_line_1" placeholder="Start typing your address here..." />
        <input type="text" id="address_line_2" placeholder="Address line 2" readonly />
        <input type="text" id="city" placeholder="City" readonly/>
        <input type="text" id="state" placeholder="State" readonly/>
        <input type="text" id="postcode" placeholder="Postcode" readonly/>
      </div>
      <div id="search-results" class="results-container"></div>
    </div>

    <script>
      const searchInput = document.getElementById("address_line_1");
      const searchResults = document.getElementById("search-results");
      console.log({
        searchInput: !!searchInput,
        searchResults: !!searchResults,
      });

      function LocateAddressSearch() {

        const widgetSettings = JFCustomWidget.getWidgetSettings();
        const searchLimit = widgetSettings.searchLimit;
        const allowedCountries = widgetSettings.allowedCountries;
        const serviceKey = widgetSettings.serviceKey;
        
        const API_LIST_URL = "https://api.addressy.com/Capture/Interactive/Find/v1.20/json6.ws";
        const API_RETRIEVE_URL =
          "https://api.addressy.com/Capture/Interactive/Find/v1.20/json6.ws";

        this.init = init;
        this.getData = getData;

        function init(formData) {
          console.log("init", { formData });
          searchInput.addEventListener("input", function (event) {
              console.log("searchInputEvent", event)
              retrieveListOfAddresses(event.target.value);
          });
        }

        function escapeHtml(text) {
          const div = document.createElement("div");
          div.textContent = text || "";
          return div.innerHTML;
        }
        async function retrieveListOfAddresses(searchTerm) {
          console.log("retrieveListOfAddresses", {searchTerm});
          if (!searchTerm) {
            return;
          }
          try {
            const searchParams = new URLSearchParams();
            searchParams.append("Key", serviceKey);
            searchParamsa.append("Text", searchTerm);
            
            const response = await fetch(
              `${API_LIST_URL}?${searchParams}`
            );
            const data = await response.json();
            displayAddresses(data.Items);
          } catch (error) {
            console.error("Search error:", error);
          }
        }

        function displayAddresses(addresses) {
    //           {
    //   "Id": "GB|RM|B|55605138|ENG",
    //   "Type": "Address",
    //   "Text": "G B G Evermore 128 Queen Victoria Street",
    //   "Highlight": "0-1,2-3,4-5",
    //   "Description": "London EC4V 4BJ"
    // }
          console.log("displayAddresses", { addresses });
          const list = document.createElement("ul");
          list.className = "address-list";

          addresses.forEach((address) => {
            const item = document.createElement("li");
            item.id = address.Id;
            item.className = "address-item";
            item.innerHTML =
              '<div class="address-name">' +
              escapeHtml(address.Text) +
              "</div>" +
              '<div class="address-details">' +
              escapeHtml(address.Description) +
              "</div>";

            item.addEventListener("click", () => selectAddress(address.id));
            list.appendChild(item);
          });

          searchResults.innerHTML = "";
          searchResults.appendChild(list);
        }

        async function selectAddress(addressId) {
          try {
            const searchParams = new URLSearchParams();
            searchParams.append("Key", serviceKey);
            searchParams.append("Id", addressId);
            
            const response = await fetch(
              `${API_RETRIEVE_URL}?${searchParams}`
            );
            const [data] = await response.json();

            console.log("selectAddress", JSON.stringify({ data }));

            if (data.Error) {
              const errorMessage = data.Error || "Invalid lookup";
              JFCustomWidget.showWidgetError(errorMessage);
              return;
            }

            setData(data);
          } catch (error) {
            console.error("Details error:", error);
          }
        }

        function setData(addressData){

      //       {
      // "Id": "GB|RM|B|55605138|ENG",
      // "DomesticId": "55605138",
      // "Language": "ENG",
      // "LanguageAlternatives": "ENG",
      // "Department": "",
      // "Company": "G B G",
      // "SubBuilding": "",
      // "BuildingNumber": "128",
      // "BuildingName": "Evermore",
      // "SecondaryStreet": "",
      // "Street": "Queen Victoria Street",
      // "Block": "",
      // "Neighbourhood": "",
      // "District": "",
      // "City": "London",
      // "Line1": "Evermore",
      // "Line2": "128 Queen Victoria Street",
      // "Line3": "",
      // "Line4": "",
      // "Line5": "",
      // "AdminAreaName": "City of London",
      // "AdminAreaCode": "",
      // "Province": "",
      // "ProvinceName": "",
      // "ProvinceCode": "",
      // "PostalCode": "EC4V 4BJ",
      // "CountryName": "United Kingdom",
      // "CountryIso2": "GB",
      // "CountryIso3": "GBR",
      // "CountryIsoNumber": "826",
      // "SortingNumber1": "74131",
      // "SortingNumber2": "",
      // "Barcode": "(EC4V4BJ2ZE)",
      // "POBoxNumber": "",
      // "Label": "G B G\nEvermore\n128 Queen Victoria Street\nLONDON\nEC4V 4BJ\nUNITED KINGDOM",
      // "Type": "Commercial",
      // "DataLevel": "Premise",
      //   }
            document.getElementById('address_line_1').value = addressData.Street;
            document.getElementById('address_line_2').value  = addressData.Line2;
            document.getElementById('city').value  = addressData.City;
            document.getElementById('state').value = addressData.ProvinceName;
            document.getElementById('postcode').value = addressData.PostalCode;
        }
  
         function getData() {
            const address_line_1 = document.getElementById('address_line_1').value;
            const address_line_2 = document.getElementById('address_line_2').value;
            const city = document.getElementById('city').value;
            const state = document.getElementById('state').value;
            const postcode = document.getElementById('postcode').value;

          return {
            valid: true,
            value: JSON.stringify({
                address_line_1,
                address_line_2,
                city,
                state,
                postcode
            })
          };
        }
      }
      JFCustomWidget.subscribe("ready", function (data) {
        var widget = new LocateAddressSearch();
        widget.init(data);

        JFCustomWidget.subscribe("submit", function () {
          JFCustomWidget.sendSubmit(widget.getData());
        });
      });
    </script>
  </body>
</html>
