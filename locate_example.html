<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jotfor.ms/s/umd/latest/for-custom-widgets.js"></script>

  <style>
    .search-form input {
      padding: 0.6rem 0.75rem;
      font-size: 12px;
      border: 1px solid #d0d5dd;
      border-radius: 6px;
      width: 100%;
      max-width: 16rem;
    }

    .address-search-wrapper {
      position: relative;
      width: 100%;
    }

    .results-container {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      z-index: 1000;
    }

    .address-list {
      list-style: none;
      padding: 0;
      margin: 0;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      max-height: 280px;
      overflow-y: auto;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    }

    .address-item {
      padding: 0.6rem 0.75rem;
      cursor: pointer;
    }

    .hidden {
      display: none;
    }

    .manual-entry-btn {
      background: none;
      border: none;
      color: #4f46e5;
      font-size: 12px;
      padding: 0;
      cursor: pointer;
      text-align: left;
    }
  </style>
</head>

<body>
  <div class="search-form" style="display:flex; flex-direction:column; gap:1rem;">

    <div class="address-search-wrapper">
      <input
        type="text"
        id="address_line_1"
        placeholder="Start typing your address here..."
      />
      <div id="search-results" class="results-container"></div>
    </div>

    <button type="button" id="manual-entry-btn" class="manual-entry-btn">
      Enter address manually
    </button>

    <div id="manual-fields" class="hidden">
      <input type="text" id="address_line_2" placeholder="Address line 2" />
      <input type="text" id="city" placeholder="City" />
      <input type="text" id="state" placeholder="State" />
      <input type="text" id="postcode" placeholder="Postcode" />
    </div>
  </div>

<script>
function LocateAddressSearch() {
  const searchInput = document.getElementById("address_line_1");
  const searchResults = document.getElementById("search-results");
  const manualBtn = document.getElementById("manual-entry-btn");
  const manualFields = document.getElementById("manual-fields");

  const settings = JFCustomWidget.getWidgetSettings();
  const serviceKey = settings.serviceKey;

  const API_LIST_URL =
    "https://api.addressy.com/Capture/Interactive/Find/v1.20/json6.ws";
  const API_RETRIEVE_URL =
    "https://api.addressy.com/Capture/Interactive/Retrieve/v1.30/json6.ws";

  let isSelecting = false;

  this.init = init;
  this.getData = getData;

  function resizeWidget() {
    // Small delay ensures DOM has updated
    setTimeout(() => {
      JFCustomWidget.requestFrameResize();
    }, 50);
  }

  function init() {

     JFWidgetTranslation.setDictionary({
        kr: {
            "Show": "보이기",
            "Showing": "표시 중",
            "entries": "항목",
            "filtered from": "에서 필터링됨",
            "total entries": "총 항목"
        }
    });
    console.log("Current dictionary:", JFWidgetTranslation.getDictionary());

    searchInput.addEventListener("input", e => {
      if (isSelecting) return;
      lookup(e.target.value);
    });

manualBtn.addEventListener("click", () => {
  manualFields.classList.remove("hidden");

  manualFields.querySelectorAll("input").forEach(input => {
    input.removeAttribute("readonly");
  });
  searchResults.innerHTML = "";
  requestAnimationFrame(() => {
    JFCustomWidget.requestFrameResize({
      height: document.body.offsetHeight + 30
    });
  });
});

  }

  async function lookup(term) {
    if (!term) {
      searchResults.innerHTML = "";
      resizeWidget();
      return;
    }

    const params = new URLSearchParams({
      Key: serviceKey,
      Text: term,
      Limit: 10
    });

    const res = await fetch(`${API_LIST_URL}?${params}`);
    const data = await res.json();

    renderResults(data.Items || []);
  }

  function renderResults(items) {
    if (!items.length) {
      searchResults.innerHTML = "";
      resizeWidget();
      return;
    }

    const ul = document.createElement("ul");
    ul.className = "address-list";

    items.forEach(item => {
      const li = document.createElement("li");
      li.className = "address-item";
      li.textContent = item.Text;
      li.addEventListener("mousedown", () => selectAddress(item.Id));
      ul.appendChild(li);
    });

    searchResults.innerHTML = "";
    searchResults.appendChild(ul);
    resizeWidget();
  }

  async function selectAddress(id) {
    isSelecting = true;

    const params = new URLSearchParams({
      Key: serviceKey,
      Id: id
    });

    const res = await fetch(`${API_RETRIEVE_URL}?${params}`);
    const data = await res.json();
    const addr = data.Items[0];

    searchInput.value = addr.Line1;
    document.getElementById("address_line_2").value = addr.Line2;
    document.getElementById("city").value = addr.City;
    document.getElementById("state").value = addr.ProvinceName;
    document.getElementById("postcode").value = addr.PostalCode;

    manualFields.classList.add("hidden");
    searchResults.innerHTML = "";

    resizeWidget();

    setTimeout(() => (isSelecting = false), 100);
  }

  function getData() {
    return {
      valid: true,
      value: JSON.stringify({
        address_line_1: searchInput.value,
        address_line_2: address_line_2.value,
        city: city.value,
        state: state.value,
        postcode: postcode.value
      })
    };
  }
}

JFCustomWidget.subscribe("ready", () => {
  const widget = new LocateAddressSearch();
  widget.init();

  JFCustomWidget.subscribe("submit", () => {
    JFCustomWidget.sendSubmit(widget.getData());
  });

   // JFCustomWidget.subscribe('translatable', () => {
   //      if (JFWidgetTranslation) {
   //        const translatableData = JFWidgetTranslation.getTranslatables(() => {
   //          const translatableTexts = [
   //            'Show',
   //            'Showing',
   //            'entries',
   //            'filtered from',
   //            'total entries'
   //          ];
   //          return translatableTexts;
   //        });
   //        JFCustomWidget.sendTranslatables(translatableData);
   //      }
   //    }, { immediateCall: true });

   JFCustomWidget.subscribe('translate', translationData => {
        if (!JFWidgetTranslation) return;
          const textsToTranslate = [
            'Show',
            'Showing',
            'entries',
            'filtered from',
            'total entries'
          ];
 console.log("Current dictionary:", JFWidgetTranslation.getDictionary());
          textsToTranslate.forEach(originalText => {
            const translation = JFWidgetTranslation.getTranslation(
              translationData,
              originalText,
              translationData.to
            );

            if (translation && translation !== '') {
              newTranslationStore[originalText] = translation;
            }
          });
        // if (JFWidgetTranslation.translate) {
        //   JFWidgetTranslation.translate(translationData);
        // }
      });
});
</script>
</body>
</html>
